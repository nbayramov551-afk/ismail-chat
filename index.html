<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem...</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background: #000; color: #0f0; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; height: 100vh; width: 100vw; }
        #login-screen { position: fixed; inset: 0; z-index: 3000; background: #000; display: flex; align-items: center; justify-content: center; }
        .terminal-box { border: 1px solid #0f0; padding: 25px; width: 85%; max-width: 320px; text-align: center; background: #050505; border-radius:15px; }
        input { background: #000; border: 1px solid #0f0; color: #0f0; padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; outline: none; text-align: center; font-size: 16px; }
        .start-btn { width: 100%; padding: 15px; background: #0f0; color: #000; font-weight: bold; cursor: pointer; border: none; border-radius:5px; text-transform: uppercase; }

        #radar-screen { position: fixed; inset: 0; z-index: 2000; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .radar { width: 100px; height: 100px; border: 3px solid #0f0; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #main-ui { display: none; width: 100%; height: 100%; position: relative; background: #111; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; bottom: 90px; right: 15px; width: 100px; height: 140px; border: 2px solid #0f0; z-index: 10; border-radius: 10px; object-fit: cover; background: #000; }

        .emoji-bar { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); display: flex; flex-direction: column; gap: 10px; z-index: 20; }
        .emoji-btn { font-size: 24px; background: rgba(0,0,0,0.6); border: 1px solid #0f0; border-radius: 50%; width: 45px; height: 45px; color: #fff; }

        .control-panel { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 10px; z-index: 20; background: rgba(0,0,0,0.85); padding: 10px; border-radius: 50px; border: 1px solid #0f0; }
        .btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: #333; color: #fff; font-size: 18px; }
        .active-red { background: #f00 !important; }

        .floating-emoji { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 80px; z-index: 100; animation: pop 1s forwards; pointer-events: none; }
        @keyframes pop { 0% { opacity:0; transform: translate(-50%, 0%); } 50% { opacity:1; } 100% { opacity:0; transform: translate(-50%, -100%); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="terminal-box">
            <h2 style="color: #0f0;">PHANTOM V25</h2>
            <input type="password" id="tk" placeholder="ÅžÄ°FRÆ">
            <input type="text" id="rm" placeholder="OTAQ ADI">
            <button class="start-btn" onclick="start('A')">BAÅžLAT (AZ)</button>
            <button class="start-btn" onclick="start('B')" style="margin-top:10px; background:#004400; color:#fff;">BAÅžLAT (RU)</button>
        </div>
    </div>

    <div id="radar-screen">
        <div class="radar"></div>
        <p style="margin-top:20px; color:#0f0;">SÄ°QNALLAR YOXLANILIR...</p>
    </div>

    <div id="main-ui">
        <video id="remote-video" playsinline autoplay></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="emoji-bar" id="emoji-list"></div>
        <div class="control-panel">
            <button class="btn" onclick="toggleMute()" id="m-btn"><i class="fas fa-microphone"></i></button>
            <button class="btn" onclick="toggleCam()" id="c-btn"><i class="fas fa-video"></i></button>
            <button class="btn" onclick="switchCam()" style="color:#0f0;"><i class="fas fa-sync-alt"></i></button>
            <button class="btn" onclick="location.reload()" style="background:#444;"><i class="fas fa-redo"></i></button>
            <button class="btn" onclick="window.location.href='https://google.com'" style="background:#600;"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <script>
        let peer, localStream, activeConn, role, targetID, myID;
        let isFront = true;
        const ice = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478' }] };

        async function initMedia(facing = "user") {
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            localStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: facing, width: 480 }, audio: true 
            });
            document.getElementById('local-video').srcObject = localStream;
            return localStream;
        }

        async function start(selRole) {
            role = selRole;
            const tk = document.getElementById('tk').value;
            const rm = document.getElementById('rm').value;
            if(!tk || !rm) return alert("BoÅŸ qoyma!");

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('radar-screen').style.display = 'flex';

            const hash = CryptoJS.SHA1(tk + rm).toString().substring(0, 8);
            myID = (role === 'A' ? 'AZ-' : 'RU-') + hash;
            targetID = (role === 'A' ? 'RU-' : 'AZ-') + hash;

            await initMedia();
            peer = new Peer(myID, { config: ice });

            peer.on('open', () => {
                setInterval(() => {
                    if (document.getElementById('main-ui').style.display === 'none') {
                        const call = peer.call(targetID, localStream);
                        if(call) handleCall(call);
                        peer.connect(targetID);
                    }
                }, 4000);
            });

            peer.on('call', call => {
                call.answer(localStream);
                handleCall(call);
            });

            peer.on('connection', conn => {
                activeConn = conn;
                conn.on('data', d => { if(d.type==='emoji') showEmoji(d.val); });
            });
        }

        function handleCall(call) {
            call.on('stream', stream => {
                const rv = document.getElementById('remote-video');
                rv.srcObject = stream;
                document.getElementById('radar-screen').style.display = 'none';
                document.getElementById('main-ui').style.display = 'block';
            });
        }

        async function switchCam() {
            isFront = !isFront;
            await initMedia(isFront ? "user" : "environment");
            // KameranÄ± dÉ™yiÅŸÉ™ndÉ™ avtomatik yenidÉ™n zÉ™ng atÄ±r (Bypass Ã¼Ã§Ã¼n É™n etibarlÄ± yol)
            const call = peer.call(targetID, localStream);
            if(call) handleCall(call);
        }

        function toggleMute() {
            localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
            document.getElementById('m-btn').classList.toggle('active-red');
        }
        function toggleCam() {
            localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled;
            document.getElementById('c-btn').classList.toggle('active-red');
        }

        const emojis = ['â¤ï¸','ðŸ˜˜','ðŸ”¥','ðŸ˜‚','ðŸ˜','ðŸ”ž','ðŸ’','ðŸ˜­'];
        const list = document.getElementById('emoji-list');
        emojis.forEach(e => {
            const b = document.createElement('button');
            b.className = 'emoji-btn';
            b.innerText = e;
            b.onclick = () => {
                showEmoji(e);
                if(activeConn) activeConn.send({type:'emoji', val:e});
            };
            list.appendChild(b);
        });

        function showEmoji(val) {
            const div = document.createElement('div');
            div.className = 'floating-emoji';
            div.innerText = val;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 1000);
        }
    </script>
</body>
</html>
