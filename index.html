<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem YÃ¼klÉ™nir...</title> <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* ÆSAS DÄ°ZAYN */
        body { 
            background: #000; color: #0f0; 
            font-family: 'Courier New', monospace; 
            margin: 0; overflow: hidden; height: 100vh; 
        }

        /* GÄ°RÄ°Å EKRANI */
        #login-screen { 
            position: fixed; inset: 0; 
            background: radial-gradient(circle, #051005 0%, #000 100%); 
            z-index: 2000; display: flex; align-items: center; justify-content: center; 
        }
        .terminal-box { 
            border: 1px solid #0f0; padding: 25px; width: 300px; 
            background: rgba(0,0,0,0.95); box-shadow: 0 0 20px #0f0; 
            border-radius: 10px; text-align: center; 
        }
        input { 
            background: #111; border: 1px solid #0f0; color: #0f0; 
            padding: 12px; margin: 10px 0; width: 100%; 
            box-sizing: border-box; outline: none; text-align: center;
        }
        .start-btn { 
            width: 48%; padding: 15px; margin-top: 5px;
            background: #0f0; color: #000; font-weight: bold; 
            cursor: pointer; border: none; text-transform: uppercase; 
            transition: 0.3s;
        }
        .start-btn:active { transform: scale(0.95); }

        /* ÆSAS VÄ°DEO SAHÆSÄ° */
        #main-ui { display: none; width: 100vw; height: 100vh; position: relative; }
        
        #remote-video { 
            width: 100%; height: 100%; object-fit: cover; 
            filter: contrast(1.1) brightness(1.1); 
            z-index: 1; position: absolute; top:0; left:0;
        }
        
        #local-video { 
            position: absolute; top: 20px; right: 20px; 
            width: 100px; height: 140px; 
            border: 2px solid #0f0; z-index: 10; 
            border-radius: 8px; box-shadow: 0 0 10px #0f0;
            object-fit: cover; transition: all 0.3s;
        }

        /* ALT PANEL (Ä°darÉ™etmÉ™) */
        .control-panel {
            position: absolute; bottom: 20px; left: 50%; 
            transform: translateX(-50%);
            display: flex; gap: 12px; z-index: 20;
            background: rgba(0, 0, 0, 0.7); padding: 12px 25px; 
            border-radius: 40px; border: 1px solid rgba(0, 255, 0, 0.4); 
            backdrop-filter: blur(8px);
        }
        .btn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: rgba(255, 255, 255, 0.1); color: white; font-size: 22px;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center;
        }
        .btn:active { background: #0f0; color: black; transform: scale(0.9); }
        .btn.active-state { background: #ff0000; color: white; box-shadow: 0 0 10px red; }

        /* EMOJÄ° BAR (SAÄDA) */
        .emoji-bar {
            position: absolute; top: 50%; right: 10px; 
            transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 8px; z-index: 20;
            max-height: 70vh; overflow-y: auto; padding-right: 5px;
        }
        .emoji-btn {
            font-size: 28px; background: none; border: none; cursor: pointer;
            transition: transform 0.2s; filter: drop-shadow(0 0 3px black);
        }
        .emoji-btn:active { transform: scale(1.4); }

        /* CANLI EMOJÄ° ANÄ°MASÄ°YASI */
        .floating-emoji {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0);
            font-size: 150px; z-index: 100; pointer-events: none;
            animation: popAndFade 2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popAndFade {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            40% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1.8); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(3); opacity: 0; filter: blur(20px); }
        }

        /* QIRMIZI Ä°ÅIQ PROBLEMÄ° MESAJI */
        #network-msg {
            position: absolute; top: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(255,0,0,0.8); color: white; padding: 10px 20px;
            border-radius: 20px; z-index: 50; display: none; font-size: 12px;
            animation: flash 1s infinite;
        }
        @keyframes flash { 0% {opacity:1;} 50% {opacity:0.5;} 100% {opacity:1;} }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="terminal-box">
            <h2 style="letter-spacing: 5px; margin-bottom: 5px;">PHANTOM V21</h2>
            <p style="font-size: 10px; color: #888;">ULTRA SECURE // P2P MESH</p>
            <input type="password" id="tk" placeholder="GÄ°ZLÄ° ÅÄ°FRÆ (TOKEN)">
            <input type="text" id="rm" placeholder="OTAQ NÃ–MRÆSÄ°">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="start-btn" onclick="initSystem('A')">AZÆRBAYCAN<br>(HOST)</button>
                <button class="start-btn" onclick="initSystem('B')" style="background: #222; color: #fff; border: 1px solid #555;">RUSÄ°YA<br>(GUEST)</button>
            </div>
        </div>
    </div>

    <div id="main-ui">
        <div id="network-msg">âš ï¸ BaÄŸlantÄ± ZÉ™ifdir! Avto-BÉ™rpa Edilir...</div>
        
        <video id="remote-video" playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>

        <div class="emoji-bar">
            <button class="emoji-btn" onclick="sendEmoji('â¤ï¸', 'heart')">â¤ï¸</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸ˜˜', 'kiss')">ğŸ˜˜</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸ’‹', 'kiss')">ğŸ’‹</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸ˜', 'love')">ğŸ˜</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸ”¥', 'fire')">ğŸ”¥</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸ˜‚', 'laugh')">ğŸ˜‚</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸ¥º', 'aww')">ğŸ¥º</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸ’', 'ring')">ğŸ’</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸŒ¹', 'love')">ğŸŒ¹</button>
            <button class="emoji-btn" onclick="sendEmoji('ğŸ˜¡', 'angry')">ğŸ˜¡</button>
        </div>

        <div class="control-panel">
            <button class="btn" onclick="toggleMute()" id="btn-mute"><i class="fas fa-microphone"></i></button>
            <button class="btn" onclick="toggleVideo()" id="btn-cam"><i class="fas fa-video"></i></button>
            <button class="btn" onclick="location.reload()"><i class="fas fa-sync"></i></button> <button class="btn" onclick="toggleVoice()" id="btn-voice" style="color: cyan;"><i class="fas fa-robot"></i></button>
            <button class="btn" onclick="window.location.href='https://google.com'" style="background:rgba(255,0,0,0.3);"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <script>
        // --- 1. TÆHLÃœKÆSÄ°ZLÄ°K VARÄ°ANTLARI ---
        let peer, localStream, currentCall, role;
        let isVoiceChangerActive = false;
        let toneSynth; // SÉ™s Ã¼Ã§Ã¼n

        // Rusiyada bloklanmamaq Ã¼Ã§Ã¼n qarÄ±ÅŸÄ±q STUN serverlÉ™ri
        const iceConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ],
            sdpSemantics: 'unified-plan'
        };

        // --- 2. SÄ°STEMÄ° BAÅLAT ---
        async function initSystem(selectedRole) {
            role = selectedRole;
            const tk = document.getElementById('tk').value;
            const rm = document.getElementById('rm').value;
            
            if(!tk || !rm) return alert("ZÉ™hmÉ™t olmasa ÅŸifrÉ™ vÉ™ otaÄŸÄ± yazÄ±n!");

            // SÉ™hifÉ™ni tÉ™mizlÉ™
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'block';

            // BaÅŸlÄ±ÄŸÄ± gizlÉ™t (Anti-Spy)
            document.title = "Google Docs"; 

            // SÉ™s Motorunu HazÄ±rla (Tone.js)
            await Tone.start();
            toneSynth = new Tone.Synth().toDestination();

            try {
                // KameranÄ± AÃ§
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 480, height: 640, frameRate: 15 }, // Optimal keyfiyyÉ™t
                    audio: { echoCancellation: true, noiseSuppression: true } 
                });
                document.getElementById('local-video').srcObject = localStream;

                // Gizli ID yaradÄ±lmasÄ±
                const uniqueId = (role === 'A' ? 'AZ-' : 'RU-') + CryptoJS.SHA1(tk + rm).toString().substring(0, 10);
                
                peer = new Peer(uniqueId, { config: iceConfig });

                peer.on('open', id => {
                    console.log("Sistem Aktivdir: " + id);
                    if(role === 'B') {
                        // Rusiya tÉ™rÉ™fisÉ™nsÉ™, avtomatik zÉ™ng et vÉ™ tÉ™krarla (QÄ±rmÄ±zÄ± iÅŸÄ±q hÉ™lli)
                        connectToHost(tk, rm);
                    }
                });

                peer.on('call', call => {
                    call.answer(localStream);
                    handleStream(call);
                });

                // EmojilÉ™ri qÉ™bul etmÉ™k Ã¼Ã§Ã¼n data kanalÄ±
                peer.on('connection', conn => {
                    conn.on('data', data => {
                        if(data.type === 'emoji') showEmojiEffect(data.content, data.sound);
                    });
                });

            } catch(e) {
                alert("Kamera vÉ™ ya Mikrofon xÉ™tasÄ±! Ä°cazÉ™ verin.");
            }
        }

        // --- 3. BAÄLANTI Ä°DARÆSÄ° ---
        function connectToHost(tk, rm) {
            const targetId = 'AZ-' + CryptoJS.SHA1(tk + rm).toString().substring(0, 10);
            const call = peer.call(targetId, localStream);
            const conn = peer.connect(targetId); // Data kanalÄ± (emoji Ã¼Ã§Ã¼n)
            
            handleStream(call);
            
            // Qlobal Conn dÉ™yiÅŸÉ™ni
            window.activeConn = conn;

            // Avto-Reconnect (QÄ±rmÄ±zÄ± iÅŸÄ±q yananda bÉ™rpa)
            setInterval(() => {
                if(peer.disconnected) peer.reconnect();
            }, 3000);
        }

        function handleStream(call) {
            currentCall = call;
            
            // Siqnal zÉ™iflÉ™yÉ™ndÉ™ xÉ™bÉ™r ver
            call.peerConnection.oniceconnectionstatechange = () => {
                if(call.peerConnection.iceConnectionState === 'disconnected') {
                    document.getElementById('network-msg').style.display = 'block';
                    call.peerConnection.restartIce(); // Avtomatik dÃ¼zÉ™ltmÉ™
                } else {
                    document.getElementById('network-msg').style.display = 'none';
                }
            };

            call.on('stream', remoteStream => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });
        }

        // --- 4. FUNKSÄ°YALAR (EMOJÄ°, SÆS, KAMERA) ---

        // EMOJÄ° GÃ–NDÆR
        function sendEmoji(emoji, soundType) {
            // Ã–z ekranÄ±nda gÃ¶stÉ™r
            showEmojiEffect(emoji, soundType);
            
            // QarÅŸÄ± tÉ™rÉ™fÉ™ gÃ¶ndÉ™r
            if(window.activeConn) {
                window.activeConn.send({ type: 'emoji', content: emoji, sound: soundType });
            } else if(currentCall) {
                // Host tÉ™rÉ™f Ã¼Ã§Ã¼nsÉ™, Guest-in ID-sini tapÄ±b gÃ¶ndÉ™rmÉ™k lazÄ±mdÄ±r (SadÉ™lÉ™ÅŸdirilmiÅŸ versiya)
                // Bu versiyada Host->Guest emoji gÃ¶ndÉ™rimi Ã¼Ã§Ã¼n É™lavÉ™ "conn" qurulmalÄ±dÄ±r.
            }
        }

        // EMOJÄ° EFFEKTÄ° (SÉ™sli vÉ™ GÃ¶rÃ¼ntÃ¼lÃ¼)
        function showEmojiEffect(emoji, soundType) {
            const el = document.createElement('div');
            el.innerText = emoji;
            el.className = 'floating-emoji';
            document.body.appendChild(el);

            // SÉ™s Oynat (Sintezator ilÉ™ - Fayl yÃ¼klÉ™mÉ™yÉ™ ehtiyac yoxdur!)
            if(soundType === 'kiss') playSound(400, 'sine', 0.1); // "Mucuk" sÉ™si
            if(soundType === 'heart') playSound(300, 'triangle', 0.2);
            if(soundType === 'laugh') playSound(600, 'sawtooth', 0.1);

            setTimeout(() => el.remove(), 2000);
        }

        function playSound(freq, type, duration) {
            const synth = new Tone.Synth({ oscillator: { type: type } }).toDestination();
            synth.triggerAttackRelease(freq, duration);
        }

        // MÄ°KROFONU SÃ–NDÃœR
        function toggleMute() {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('btn-mute').classList.toggle('active-state');
        }

        // KAMERANI SÃ–NDÃœR (QaranlÄ±q)
        function toggleVideo() {
            const track = localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('btn-cam').classList.toggle('active-state');
        }

        // SÆS DÆYÄ°ÅDÄ°RÄ°CÄ° (Robot SimulyasiyasÄ±)
        function toggleVoice() {
            isVoiceChangerActive = !isVoiceChangerActive;
            const btn = document.getElementById('btn-voice');
            
            if(isVoiceChangerActive) {
                btn.classList.add('active-state');
                alert("Robot rejimi: Bu funksiya tam aktivlÉ™ÅŸmÉ™si Ã¼Ã§Ã¼n server tÉ™rÉ™fli emal tÉ™lÉ™b edir, hazÄ±rda yalnÄ±z simulyasiyadÄ±r.");
                // Brauzer daxilindÉ™ tam sÉ™s dÉ™yiÅŸimi Ã§ox aÄŸÄ±r olduÄŸu Ã¼Ã§Ã¼n simulyasiya edirik.
            } else {
                btn.classList.remove('active-state');
            }
        }

    </script>
</body>
</html>
